<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Book Generator - Create Professional Ebooks with AI</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Enterprise Light Theme */
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #3b82f6;
            --secondary: #7c3aed;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;

            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;

            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);

            /* Book reading colors */
            --book-page: #fdfbf7;
            --book-page-alt: #f9f7f3;
            --book-text: #1a1a1a;
            --book-border: #d4cfc4;
            --book-sidebar: #f0ece4;
        }

        [data-theme="dark"] {
            /* Enterprise Dark Theme */
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #60a5fa;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;

            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border: #334155;
            --border-light: #1e293b;

            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px -1px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3);

            /* Book reading colors - dark mode */
            --book-page: #1e293b;
            --book-page-alt: #334155;
            --book-text: #e2e8f0;
            --book-border: #475569;
            --book-sidebar: #0f172a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            box-shadow: var(--shadow-md);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            font-size: 1.75rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .usage-badge {
            background: var(--bg-tertiary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            border: 1px solid var(--border);
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
            transform: scale(1.05);
        }

        .btn-logout {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #dc2626;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Auth Screen */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .auth-card {
            background: var(--bg-primary);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            padding: 3rem;
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--border);
        }

        .auth-card h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 700;
        }

        .auth-card p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--light-gray);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            width: auto;
        }

        /* Main App */
        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 1rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Create Book Section */
        .create-book-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .create-book-card h2 {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            font-weight: 700;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Book List */
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .book-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }

        .book-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .book-card h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .book-card p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .book-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .book-progress {
            font-size: 0.875rem;
            color: var(--primary);
            font-weight: 600;
        }

        .book-type-badge {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Library Grid */
        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
        }

        .library-book-card {
            background: var(--bg-primary);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--border);
        }

        .library-book-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.2);
        }

        .library-book-cover {
            width: 100%;
            aspect-ratio: 2/3;
            overflow: hidden;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .library-book-cover svg {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .library-book-info {
            padding: 1.25rem;
        }

        .library-book-info h3 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        .library-book-meta {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Immersive Reader Modal */
        .reader-modal {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .reader-modal.active {
            display: flex;
        }

        .reader-header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reader-title h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .reader-title p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .reader-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .reader-body {
            flex: 1;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            padding: 2rem;
            background: var(--book-page);
        }

        .reader-content {
            max-width: 800px;
            width: 100%;
            background: var(--bg-primary);
            padding: 3rem;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            font-family: Georgia, 'Times New Roman', serif;
            line-height: 1.8;
            color: var(--book-text);
        }

        .reader-content h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .reader-content h2 {
            font-size: 1.75rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: var(--secondary);
        }

        .reader-content p {
            margin-bottom: 1.25rem;
            text-align: justify;
        }

        .reader-navigation {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Book Editor - ENTERPRISE BOOK READING EXPERIENCE */
        .editor-container {
            background: var(--book-page);
            border-radius: 12px;
            padding: 0;
            box-shadow: var(--shadow-lg);
            margin: 2rem auto;
            max-width: 1400px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .editor-header {
            background: var(--bg-primary);
            border-bottom: 2px solid var(--border);
            color: var(--text-primary);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-title h2 {
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .editor-title p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .editor-actions {
            display: flex;
            gap: 0.75rem;
        }

        .pages-container {
            display: flex;
            gap: 0;
            background: var(--book-page);
        }

        /* Sidebar styled like book index */
        .pages-sidebar {
            width: 280px;
            flex-shrink: 0;
            background: var(--book-sidebar);
            border-right: 2px solid var(--book-border);
            padding: 1.5rem 1rem;
            max-height: 800px;
            overflow-y: auto;
        }

        .pages-sidebar h4 {
            font-family: 'Georgia', 'Times New Roman', serif;
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary);
        }

        .page-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .page-item {
            padding: 0.875rem;
            border: 1px solid transparent;
            border-left: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            border-radius: 6px;
            font-family: 'Georgia', 'Times New Roman', serif;
        }

        .page-item:hover {
            background: var(--bg-tertiary);
            border-left-color: var(--primary);
        }

        .page-item.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-left-color: var(--primary);
            border-left-width: 3px;
            border-color: var(--border);
        }

        .page-item-number {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .page-item.active .page-item-number {
            color: var(--text-primary);
        }

        .page-item-section {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-style: italic;
        }

        /* Main reading area - like an actual book page */
        .page-editor {
            flex: 1;
            background: var(--book-page-alt);
            padding: 3rem 4rem;
            max-width: 900px;
            margin: 0 auto;
        }

        .page-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--book-border);
        }

        .page-editor-header h3 {
            color: var(--text-primary);
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Book page content area - professional typography */
        .page-content-area {
            border: none;
            border-radius: 0;
            padding: 2rem 0;
            min-height: 500px;
            background: transparent;
            line-height: 1.8;
            white-space: pre-wrap;

            /* Book typography */
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 1.125rem;
            color: var(--book-text);
            text-align: justify;
        }

        .page-content-area p {
            margin-bottom: 1rem;
            text-indent: 2rem; /* First line indent */
        }

        .page-content-area h1,
        .page-content-area h2,
        .page-content-area h3 {
            text-indent: 0;
            text-align: left;
            font-family: 'Georgia', 'Times New Roman', serif;
            margin: 1.5rem 0 1rem 0;
        }

        .page-content-area h1 {
            font-size: 2rem;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .page-content-area h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .page-content-area[contenteditable="true"] {
            outline: none;
        }

        .page-content-area[contenteditable="true"]:focus {
            box-shadow: inset 0 0 0 2px var(--primary-light);
            background: var(--bg-primary);
            border-radius: 4px;
            padding: 2rem 1rem;
        }

        .generate-next-section {
            margin-top: 3rem;
            padding: 2rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .generate-next-section h4 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 1.1rem;
        }

        .generate-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .generate-options input {
            flex: 1;
            font-family: 'Georgia', 'Times New Roman', serif;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.75rem;
            border-radius: 6px;
        }

        .generate-options input:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .spinner-content {
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
        }

        .spinner-large {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 1rem;
        }

        .spinner-content h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .spinner-content p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert-success {
            background: rgba(5, 150, 105, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .alert-error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .alert-info {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .books-grid {
                grid-template-columns: 1fr;
            }

            .pages-container {
                flex-direction: column;
            }

            .pages-sidebar {
                width: 100%;
                max-height: 250px;
                border-right: none;
                border-bottom: 2px solid #d4cfc4;
            }

            .page-editor {
                padding: 2rem 1.5rem;
            }

            .page-content-area {
                font-size: 1rem;
                padding: 1rem 0;
            }

            .tabs {
                flex-direction: column;
            }

            .editor-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .editor-actions {
                width: 100%;
                flex-direction: column;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <h1>üìö AI Book Generator</h1>
            <p>Create professional ebooks with AI in minutes</p>

            <form id="authForm" onsubmit="handleAuth(event)">
                <div class="form-group">
                    <label for="licenseKey">Enter Your License Key</label>
                    <input
                        type="text"
                        id="licenseKey"
                        placeholder="Your Gumroad license key"
                        required
                    >
                </div>

                <button type="submit" class="btn" id="authBtn">
                    <span id="authBtnText">Access Book Generator</span>
                    <span id="authBtnLoading" class="loading hidden"></span>
                </button>

                <p class="mt-2" style="font-size: 0.875rem;">
                    Don't have a license?
                    <a href="https://blazestudiox.gumroad.com/l/aibookgenerator" target="_blank" style="color: var(--primary);">
                        Purchase here
                    </a>
                </p>
            </form>

            <div id="authError" class="alert alert-error hidden mt-2">
                <span>‚ùå</span>
                <span id="authErrorText"></span>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="main-app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üìö</span>
                    <span>AI Book Generator</span>
                </div>
                <div class="user-info">
                    <div class="usage-badge" id="usageDisplay">
                        üìä Loading...
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode" id="themeToggle">
                        üåô
                    </button>
                    <button class="btn-logout" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('create')">
                    ‚ú® Create New Book
                </button>
                <button class="tab" onclick="switchTab('mybooks')">
                    üìù In Progress
                </button>
                <button class="tab" onclick="switchTab('library')">
                    üìö Library
                </button>
            </div>

            <!-- Create Book Tab -->
            <div id="createTab" class="tab-content active">
                <div class="create-book-card">
                    <h2>Create Your Book</h2>
                    <form id="createBookForm" onsubmit="handleCreateBook(event)">
                        <div class="form-group">
                            <label for="bookDescription">
                                What is your book about? *
                            </label>
                            <textarea
                                id="bookDescription"
                                placeholder="Example: A children's book about a brave little robot who learns to overcome his fear of the dark by making friends with fireflies."
                                required
                                minlength="10"
                                maxlength="1000"
                            ></textarea>
                            <small style="color: var(--gray);">
                                Be specific about the theme, characters, and message you want to convey.
                            </small>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="targetPages">Number of Pages *</label>
                                <input
                                    type="number"
                                    id="targetPages"
                                    min="5"
                                    max="100"
                                    value="20"
                                    required
                                >
                                <small style="color: var(--gray);">
                                    Between 5-100 pages
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="bookType">Book Type *</label>
                                <select id="bookType" required>
                                    <option value="general">General</option>
                                    <option value="kids">Kids Book</option>
                                    <option value="adult">Adult Book</option>
                                    <option value="educational">Educational</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn" id="createBookBtn">
                            <span id="createBookBtnText">üöÄ Generate Book Structure</span>
                        </button>
                    </form>
                </div>

                <div id="createBookSuccess" class="alert alert-success hidden">
                    <span>‚úÖ</span>
                    <span>Book created successfully! Switching to editor...</span>
                </div>

                <div id="createBookError" class="alert alert-error hidden">
                    <span>‚ùå</span>
                    <span id="createBookErrorText"></span>
                </div>
            </div>

            <!-- My Books Tab (In Progress) -->
            <div id="mybooksTab" class="tab-content">
                <div id="booksList" class="books-grid">
                    <!-- In-progress books will be loaded here -->
                </div>

                <div id="booksEmpty" class="empty-state hidden">
                    <div class="empty-state-icon">üìù</div>
                    <h3>No books in progress</h3>
                    <p>Create your first book to get started!</p>
                    <button class="btn btn-small mt-2" onclick="switchTab('create')">
                        Create New Book
                    </button>
                </div>
            </div>

            <!-- Library Tab (Completed Books) -->
            <div id="libraryTab" class="tab-content">
                <div id="libraryGrid" class="library-grid">
                    <!-- Completed books will be loaded here -->
                </div>

                <div id="libraryEmpty" class="empty-state hidden">
                    <div class="empty-state-icon">üìö</div>
                    <h3>No completed books yet</h3>
                    <p>Complete a book to add it to your library!</p>
                    <button class="btn btn-small mt-2" onclick="switchTab('mybooks')">
                        View In Progress
                    </button>
                </div>
            </div>

            <!-- Book Editor Tab (hidden by default) -->
            <div id="editorTab" class="tab-content">
                <div class="editor-container">
                    <div class="editor-header">
                        <div class="editor-title">
                            <h2 id="editorBookTitle">Book Title</h2>
                            <p id="editorBookMeta">0 of 0 pages</p>
                        </div>
                        <div class="editor-actions">
                            <button class="btn btn-small btn-secondary" onclick="closeEditor()">
                                ‚Üê Back to Books
                            </button>
                            <button class="btn btn-small" onclick="exportBook()" id="exportBtn">
                                üìö Export EPUB
                            </button>
                            <button class="btn btn-small hidden" onclick="completeBook()" id="completeBtn" style="background: var(--success);">
                                ‚ú® Complete Book
                            </button>
                            <button class="btn btn-small" onclick="deleteCurrentBook()" style="background: var(--danger);">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>

                    <div class="pages-container">
                        <div class="pages-sidebar">
                            <h4 style="margin-bottom: 1rem; color: var(--dark);">Pages</h4>
                            <div id="pagesList" class="page-list">
                                <!-- Pages will be loaded here -->
                            </div>
                        </div>

                        <div class="page-editor">
                            <div class="page-editor-header">
                                <h3 id="currentPageTitle">Page 1</h3>
                                <button
                                    class="btn btn-small"
                                    onclick="saveCurrentPage()"
                                    id="savePageBtn"
                                >
                                    üíæ Save Changes
                                </button>
                            </div>

                            <div
                                id="pageContentArea"
                                class="page-content-area"
                                contenteditable="true"
                                onblur="markPageAsEdited()"
                            >
                                Select a page to start editing...
                            </div>

                            <div id="generateNextSection" class="generate-next-section hidden">
                                <h4>Generate Next Page</h4>
                                <p style="color: var(--gray); margin-bottom: 1rem; font-size: 0.875rem;">
                                    Let AI create the next page, or provide guidance for specific content.
                                </p>

                                <div class="generate-options">
                                    <input
                                        type="text"
                                        id="pageGuidance"
                                        placeholder="Optional: Guide the AI (e.g., 'Make this page focus on the robot meeting his first friend')"
                                    >
                                </div>

                                <button
                                    class="btn"
                                    onclick="generateNextPage()"
                                    id="generateNextBtn"
                                >
                                    ‚ú® Generate Next Page
                                </button>
                            </div>

                            <div id="bookCompleteSection" class="generate-next-section hidden" style="background: #d1fae5;">
                                <h4 style="color: #065f46;">üéâ Book Complete!</h4>
                                <p style="color: #047857; margin-bottom: 1rem;">
                                    All pages have been generated. You can still edit any page or export your book.
                                </p>
                                <button class="btn" onclick="exportBook()">
                                    üìö Export as EPUB
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner Overlay -->
    <div id="spinnerOverlay" class="spinner-overlay hidden">
        <div class="spinner-content">
            <div class="spinner-large"></div>
            <h3 id="spinnerTitle">Processing...</h3>
            <p id="spinnerMessage">Please wait...</p>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Book?</h3>
                <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
            </div>
            <p style="color: var(--gray); margin-bottom: 1.5rem;">
                Are you sure you want to delete this book? This action cannot be undone.
            </p>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">
                    Cancel
                </button>
                <button class="btn" style="background: var(--danger);" onclick="confirmDelete()">
                    Delete Book
                </button>
            </div>
        </div>
    </div>

    <!-- Immersive Reader Modal -->
    <div id="readerModal" class="reader-modal">
        <div class="reader-header">
            <div class="reader-title">
                <h2 id="readerBookTitle">Book Title</h2>
                <p id="readerBookMeta">0 pages</p>
            </div>
            <div class="reader-controls">
                <button class="btn btn-small" onclick="closeReader()">
                    ‚úï Close
                </button>
            </div>
        </div>
        <div class="reader-body">
            <div class="reader-content" id="readerContent">
                <!-- Book content will be rendered here -->
            </div>
        </div>
        <div class="reader-navigation">
            <button class="btn btn-small btn-secondary" onclick="readerPrevPage()" id="readerPrevBtn">
                ‚Üê Previous
            </button>
            <span id="readerPageIndicator" style="color: var(--text-secondary);">Page 1 of 10</span>
            <button class="btn btn-small btn-secondary" onclick="readerNextPage()" id="readerNextBtn">
                Next ‚Üí
            </button>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://aibook-815a.onrender.com'; // Deployed backend URL

        // State
        let currentLicenseKey = '';
        let currentBook = null;
        let currentPageNumber = 1;
        let hasUnsavedChanges = false;
        let readerBook = null;
        let readerCurrentPage = 0;

        // Theme Management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('aibook_theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeToggle(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('aibook_theme', newTheme);
            updateThemeToggle(newTheme);
        }

        function updateThemeToggle(theme) {
            const toggle = document.getElementById('themeToggle');
            if (toggle) {
                toggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                toggle.title = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            // Check for saved license key
            const savedLicense = localStorage.getItem('aibook_license');
            if (savedLicense) {
                currentLicenseKey = savedLicense;
                validateLicenseAndInit();
            }
        });

        // Auth Functions
        async function handleAuth(event) {
            event.preventDefault();

            const licenseKey = document.getElementById('licenseKey').value.trim();
            const authBtn = document.getElementById('authBtn');
            const authBtnText = document.getElementById('authBtnText');
            const authBtnLoading = document.getElementById('authBtnLoading');
            const authError = document.getElementById('authError');

            // Show loading
            authBtn.disabled = true;
            authBtnText.classList.add('hidden');
            authBtnLoading.classList.remove('hidden');
            authError.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/api/usage`, {
                    headers: {
                        'Authorization': `Bearer ${licenseKey}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Save license key
                    currentLicenseKey = licenseKey;
                    localStorage.setItem('aibook_license', licenseKey);

                    // Show main app
                    showMainApp();
                    loadUsageStats();
                    loadBooks();
                } else {
                    throw new Error(data.error || 'Invalid license key');
                }
            } catch (error) {
                document.getElementById('authErrorText').textContent = error.message;
                authError.classList.remove('hidden');
            } finally {
                authBtn.disabled = false;
                authBtnText.classList.remove('hidden');
                authBtnLoading.classList.add('hidden');
            }
        }

        async function validateLicenseAndInit() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/usage`, {
                    headers: {
                        'Authorization': `Bearer ${currentLicenseKey}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showMainApp();
                    loadUsageStats();
                    loadBooks();
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        function showMainApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
        }

        function logout() {
            localStorage.removeItem('aibook_license');
            currentLicenseKey = '';
            currentBook = null;
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('licenseKey').value = '';
        }

        // Usage Stats
        async function loadUsageStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/usage`, {
                    headers: {
                        'Authorization': `Bearer ${currentLicenseKey}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const stats = data.usage;
                    document.getElementById('usageDisplay').textContent =
                        `üìä ${stats.book_count} books ‚Ä¢ ${stats.page_count} pages generated`;
                }
            } catch (error) {
                console.error('Failed to load usage stats:', error);
            }
        }

        // Tab Navigation
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tabName === 'create') {
                document.getElementById('createTab').classList.add('active');
            } else if (tabName === 'mybooks') {
                document.getElementById('mybooksTab').classList.add('active');
                loadInProgressBooks();
            } else if (tabName === 'library') {
                document.getElementById('libraryTab').classList.add('active');
                loadCompletedBooks();
            }
        }

        // Create Book
        async function handleCreateBook(event) {
            event.preventDefault();

            const description = document.getElementById('bookDescription').value.trim();
            const targetPages = parseInt(document.getElementById('targetPages').value);
            const bookType = document.getElementById('bookType').value;

            const createBookBtn = document.getElementById('createBookBtn');
            const createBookError = document.getElementById('createBookError');
            const createBookSuccess = document.getElementById('createBookSuccess');

            // Show loading
            showSpinner('Creating Your Book...', 'Generating structure and first page with AI');
            createBookBtn.disabled = true;
            createBookError.classList.add('hidden');
            createBookSuccess.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/api/books`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentLicenseKey}`
                    },
                    body: JSON.stringify({
                        description,
                        target_pages: targetPages,
                        book_type: bookType
                    })
                });

                const data = await response.json();

                if (data.success) {
                    createBookSuccess.classList.remove('hidden');

                    // Load the book in editor
                    setTimeout(() => {
                        openBookEditor(data.book);
                        // Reset form
                        document.getElementById('createBookForm').reset();
                        createBookSuccess.classList.add('hidden');
                    }, 1500);
                } else {
                    throw new Error(data.error || 'Failed to create book');
                }
            } catch (error) {
                document.getElementById('createBookErrorText').textContent = error.message;
                createBookError.classList.remove('hidden');
            } finally {
                hideSpinner();
                createBookBtn.disabled = false;
            }
        }

        // Load In-Progress Books
        async function loadInProgressBooks() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/books/in-progress`, {
                    headers: {
                        'Authorization': `Bearer ${currentLicenseKey}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const booksList = document.getElementById('booksList');
                    const booksEmpty = document.getElementById('booksEmpty');

                    if (data.books.length === 0) {
                        booksList.innerHTML = '';
                        booksEmpty.classList.remove('hidden');
                    } else {
                        booksEmpty.classList.add('hidden');
                        booksList.innerHTML = data.books.map(book => `
                            <div class="book-card" onclick="loadBookAndEdit('${book.book_id}')">
                                <h3>${book.title}</h3>
                                <p>${book.description.substring(0, 100)}${book.description.length > 100 ? '...' : ''}</p>
                                <div class="book-meta">
                                    <span class="book-progress">
                                        ${book.page_count} / ${book.target_pages} pages
                                    </span>
                                    <span class="book-type-badge">
                                        ${book.book_type}
                                    </span>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Failed to load in-progress books:', error);
            }
        }

        // Load Completed Books (Library)
        async function loadCompletedBooks() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/books/completed`, {
                    headers: {
                        'Authorization': `Bearer ${currentLicenseKey}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const libraryGrid = document.getElementById('libraryGrid');
                    const libraryEmpty = document.getElementById('libraryEmpty');

                    if (data.books.length === 0) {
                        libraryGrid.innerHTML = '';
                        libraryEmpty.classList.remove('hidden');
                    } else {
                        libraryEmpty.classList.add('hidden');
                        libraryGrid.innerHTML = data.books.map(book => `
                            <div class="library-book-card" onclick="openImmersiveReader('${book.book_id}')">
                                <div class="library-book-cover">
                                    ${book.cover_svg}
                                </div>
                                <div class="library-book-info">
                                    <h3>${book.title}</h3>
                                    <p class="library-book-meta">${book.page_count} pages ‚Ä¢ ${book.book_type}</p>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Failed to load completed books:', error);
            }
        }

        // Legacy function for compatibility
        async function loadBooks() {
            return loadInProgressBooks();
        }

        // Load and edit book
        async function loadBookAndEdit(bookId) {
            showSpinner('Loading Book...', 'Loading all pages');

            try {
                const response = await fetch(`${API_BASE_URL}/api/books/${bookId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentLicenseKey}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    openBookEditor(data.book);
                } else {
                    throw new Error(data.error || 'Failed to load book');
                }
            } catch (error) {
                alert('Failed to load book: ' + error.message);
            } finally {
                hideSpinner();
            }
        }

        // Open Book Editor
        function openBookEditor(book) {
            currentBook = book;
            currentPageNumber = 1;
            hasUnsavedChanges = false;

            // Hide other tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Show editor tab
            document.getElementById('editorTab').classList.add('active');

            // Update header
            document.getElementById('editorBookTitle').textContent = book.title;
            document.getElementById('editorBookMeta').textContent =
                `${book.pages.length} of ${book.target_pages} pages`;

            // Show Complete button if book is complete
            const completeBtn = document.getElementById('completeBtn');
            if (book.pages.length >= book.target_pages) {
                completeBtn.classList.remove('hidden');
            } else {
                completeBtn.classList.add('hidden');
            }

            // Load pages list
            const pagesList = document.getElementById('pagesList');
            pagesList.innerHTML = book.pages.map(page => `
                <div class="page-item ${page.page_number === 1 ? 'active' : ''}"
                     onclick="selectPage(${page.page_number})">
                    <div class="page-item-number">Page ${page.page_number}</div>
                    <div class="page-item-section">${page.section}</div>
                </div>
            `).join('');

            // Load first page
            selectPage(1);
        }

        // Select Page
        function selectPage(pageNumber) {
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Discard them?')) {
                    return;
                }
                hasUnsavedChanges = false;
            }

            currentPageNumber = pageNumber;

            // Update active state in sidebar
            document.querySelectorAll('.page-item').forEach((item, index) => {
                item.classList.toggle('active', index + 1 === pageNumber);
            });

            // Find page data
            const page = currentBook.pages.find(p => p.page_number === pageNumber);

            if (page) {
                document.getElementById('currentPageTitle').textContent =
                    `Page ${page.page_number}: ${page.section}`;
                document.getElementById('pageContentArea').textContent = page.content;

                // Hide generate next section
                document.getElementById('generateNextSection').classList.add('hidden');
                document.getElementById('bookCompleteSection').classList.add('hidden');
            }

            // Show generate next section if this is the last page and book not complete
            if (pageNumber === currentBook.pages.length &&
                currentBook.pages.length < currentBook.target_pages) {
                document.getElementById('generateNextSection').classList.remove('hidden');
            }

            // Show complete section if book is complete
            if (currentBook.pages.length >= currentBook.target_pages &&
                pageNumber === currentBook.pages.length) {
                document.getElementById('bookCompleteSection').classList.remove('hidden');
            }
        }

        // Mark page as edited
        function markPageAsEdited() {
            hasUnsavedChanges = true;
        }

        // Save Current Page
        async function saveCurrentPage() {
            const content = document.getElementById('pageContentArea').textContent;
            const savePageBtn = document.getElementById('savePageBtn');

            savePageBtn.disabled = true;
            savePageBtn.textContent = 'üíæ Saving...';

            try {
                const response = await fetch(`${API_BASE_URL}/api/books/update-page`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentLicenseKey}`
                    },
                    body: JSON.stringify({
                        book_id: currentBook.book_id,
                        page_number: currentPageNumber,
                        content: content
                    })
                });

                const data = await response.json();

                if (data.success) {
                    hasUnsavedChanges = false;

                    // Update local book data
                    const page = currentBook.pages.find(p => p.page_number === currentPageNumber);
                    if (page) {
                        page.content = content;
                    }

                    savePageBtn.textContent = '‚úÖ Saved!';
                    setTimeout(() => {
                        savePageBtn.textContent = 'üíæ Save Changes';
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Failed to save page');
                }
            } catch (error) {
                alert('Failed to save page: ' + error.message);
                savePageBtn.textContent = '‚ùå Failed';
                setTimeout(() => {
                    savePageBtn.textContent = 'üíæ Save Changes';
                }, 2000);
            } finally {
                savePageBtn.disabled = false;
            }
        }

        // Generate Next Page
        async function generateNextPage() {
            const guidance = document.getElementById('pageGuidance').value.trim();
            const generateNextBtn = document.getElementById('generateNextBtn');

            const nextPageNumber = currentBook.pages.length + 1;

            showSpinner('Generating Next Page...', `Creating page ${nextPageNumber} with AI`);
            generateNextBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api/books/generate-page`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentLicenseKey}`
                    },
                    body: JSON.stringify({
                        book_id: currentBook.book_id,
                        page_number: nextPageNumber,
                        user_input: guidance || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Add new page to book
                    currentBook.pages.push(data.page);

                    // Update meta
                    document.getElementById('editorBookMeta').textContent =
                        `${currentBook.pages.length} of ${currentBook.target_pages} pages`;

                    // Add page to sidebar
                    const pagesList = document.getElementById('pagesList');
                    const newPageItem = document.createElement('div');
                    newPageItem.className = 'page-item';
                    newPageItem.onclick = () => selectPage(data.page.page_number);
                    newPageItem.innerHTML = `
                        <div class="page-item-number">Page ${data.page.page_number}</div>
                        <div class="page-item-section">${data.page.section}</div>
                    `;
                    pagesList.appendChild(newPageItem);

                    // Clear guidance input
                    document.getElementById('pageGuidance').value = '';

                    // Select the new page
                    selectPage(data.page.page_number);

                    // Update usage stats
                    loadUsageStats();
                } else {
                    throw new Error(data.error || 'Failed to generate page');
                }
            } catch (error) {
                alert('Failed to generate page: ' + error.message);
            } finally {
                hideSpinner();
                generateNextBtn.disabled = false;
            }
        }

        // Export Book
        async function exportBook() {
            const exportBtn = document.getElementById('exportBtn');

            showSpinner('Exporting to EPUB...', 'Creating your professional ebook (industry standard format for Amazon, Etsy, etc.)');
            exportBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api/books/export`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentLicenseKey}`
                    },
                    body: JSON.stringify({
                        book_id: currentBook.book_id
                    })
                });

                if (response.ok) {
                    // Download the EPUB
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${currentBook.title.replace(/\s+/g, '_')}.epub`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to export book');
                }
            } catch (error) {
                alert('Failed to export book: ' + error.message);
            } finally {
                hideSpinner();
                exportBtn.disabled = false;
            }
        }

        // Delete Book
        function deleteCurrentBook() {
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }

        async function confirmDelete() {
            closeDeleteModal();
            showSpinner('Deleting Book...', 'Removing book and all pages');

            try {
                const response = await fetch(`${API_BASE_URL}/api/books/${currentBook.book_id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentLicenseKey}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Close editor and go back to books
                    closeEditor();
                    loadBooks();
                } else {
                    throw new Error(data.error || 'Failed to delete book');
                }
            } catch (error) {
                alert('Failed to delete book: ' + error.message);
            } finally {
                hideSpinner();
            }
        }

        // Close Editor
        function closeEditor() {
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Discard them?')) {
                    return;
                }
            }

            currentBook = null;
            hasUnsavedChanges = false;

            // Show my books tab
            document.getElementById('editorTab').classList.remove('active');
            document.getElementById('mybooksTab').classList.add('active');

            // Update tab buttons
            document.querySelectorAll('.tab').forEach((tab, index) => {
                tab.classList.toggle('active', index === 1);
            });

            loadBooks();
        }

        // Spinner Functions
        function showSpinner(title, message) {
            document.getElementById('spinnerTitle').textContent = title;
            document.getElementById('spinnerMessage').textContent = message;
            document.getElementById('spinnerOverlay').classList.remove('hidden');
        }

        function hideSpinner() {
            document.getElementById('spinnerOverlay').classList.add('hidden');
        }

        // Complete Book Function
        async function completeBook() {
            if (!currentBook) return;

            if (!confirm('Complete this book and generate an AI cover? Once completed, you can read it in your Library!')) {
                return;
            }

            showSpinner('Completing Book...', 'Generating AI-powered book cover');

            try {
                const response = await fetch(`${API_BASE_URL}/api/books/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentLicenseKey}`
                    },
                    body: JSON.stringify({
                        book_id: currentBook.book_id
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('üéâ Book completed! Your AI-generated cover is ready. Check your Library!');
                    closeEditor();
                    switchTab('library');
                } else {
                    throw new Error(data.error || 'Failed to complete book');
                }
            } catch (error) {
                alert('Failed to complete book: ' + error.message);
            } finally {
                hideSpinner();
            }
        }

        // Open Immersive Reader
        async function openImmersiveReader(bookId) {
            showSpinner('Opening Book...', 'Loading your book');

            try {
                const response = await fetch(`${API_BASE_URL}/api/books/${bookId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentLicenseKey}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    readerBook = data.book;
                    readerCurrentPage = 0;
                    openReader();
                } else {
                    throw new Error(data.error || 'Failed to load book');
                }
            } catch (error) {
                alert('Failed to open book: ' + error.message);
            } finally {
                hideSpinner();
            }
        }

        // Open Reader Modal
        function openReader() {
            if (!readerBook) return;

            document.getElementById('readerBookTitle').textContent = readerBook.title;
            document.getElementById('readerBookMeta').textContent = `${readerBook.pages.length} pages`;

            renderReaderPage();

            document.getElementById('readerModal').classList.add('active');
        }

        // Close Reader
        function closeReader() {
            document.getElementById('readerModal').classList.remove('active');
            readerBook = null;
            readerCurrentPage = 0;
        }

        // Render Reader Page
        function renderReaderPage() {
            if (!readerBook || !readerBook.pages[readerCurrentPage]) return;

            const page = readerBook.pages[readerCurrentPage];
            const content = page.content;

            // Convert markdown to HTML for immersive reading
            let html = content;

            // Convert headers
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');

            // Convert bold
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // Convert bullet points
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/^(\* .+)$/gm, '<li>$1</li>');

            // Wrap lists
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

            // Convert paragraphs
            html = html.split('\n\n').map(para => {
                if (para.startsWith('<h1>') || para.startsWith('<h2>') || para.startsWith('<ul>')) {
                    return para;
                }
                return `<p>${para}</p>`;
            }).join('\n');

            document.getElementById('readerContent').innerHTML = html;

            // Update navigation
            document.getElementById('readerPageIndicator').textContent =
                `Page ${readerCurrentPage + 1} of ${readerBook.pages.length}`;

            document.getElementById('readerPrevBtn').disabled = readerCurrentPage === 0;
            document.getElementById('readerNextBtn').disabled =
                readerCurrentPage === readerBook.pages.length - 1;
        }

        // Reader Navigation
        function readerPrevPage() {
            if (readerCurrentPage > 0) {
                readerCurrentPage--;
                renderReaderPage();
                document.getElementById('readerContent').scrollTop = 0;
            }
        }

        function readerNextPage() {
            if (readerCurrentPage < readerBook.pages.length - 1) {
                readerCurrentPage++;
                renderReaderPage();
                document.getElementById('readerContent').scrollTop = 0;
            }
        }

        // Keyboard navigation for reader
        document.addEventListener('keydown', (e) => {
            const readerModal = document.getElementById('readerModal');
            if (readerModal.classList.contains('active')) {
                if (e.key === 'ArrowLeft') {
                    readerPrevPage();
                } else if (e.key === 'ArrowRight') {
                    readerNextPage();
                } else if (e.key === 'Escape') {
                    closeReader();
                }
            }
        });

        // Prevent accidental page close with unsaved changes
        window.addEventListener('beforeunload', (event) => {
            if (hasUnsavedChanges) {
                event.preventDefault();
                event.returnValue = '';
            }
        });
    </script>
</body>
</html>
